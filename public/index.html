<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast QR Scanner</title>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #111; color: white; text-align: center; margin: 0; padding: 0; }
        
        /* Layout */
        .container { max-width: 100%; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Buttons */
        button { padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 50px; margin: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        input { padding: 15px; font-size: 18px; border-radius: 8px; border: none; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; }

        /* Scanner Area - Full Width for ease */
        #reader { width: 100%; max-width: 500px; background: #000; margin: 0 auto; border-radius: 12px; overflow: hidden; }
        
        /* Views */
        #menu-view, #admin-view, #user-view { width: 100%; display: none; }
        .visible { display: flex !important; flex-direction: column; align-items: center; }

        /* Results */
        .scanned-data { background: #222; padding: 15px; margin: 10px; border-radius: 8px; border-left: 5px solid #0f0; text-align: left; width: 90%; max-width: 400px; word-break: break-all; animation: flash 0.5s; }
        @keyframes flash { 0% { background-color: #0f0; } 100% { background-color: #222; } }
        
        .status { color: #888; margin-top: 10px; font-size: 0.9em; }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<div class="container">

    <div id="menu-view" class="visible">
        <h1>ðŸš€ Turbo Scanner</h1>
        <button onclick="setupAdmin()">Create Room (Scan)</button>
        <button onclick="setupUser()">Join Room (View)</button>
    </div>

    <div id="admin-view">
        <div style="margin-bottom: 10px;">Room: <span id="admin-room-code" style="color:#0f0; font-weight:bold; font-size:1.2em;">...</span></div>
        
        <div id="reader"></div>
        
        <div id="scan-feedback" class="status">Point camera at a QR code</div>
        <button onclick="location.reload()" style="background: #333; margin-top:20px;">Exit</button>
    </div>

    <div id="user-view">
        <h2>Viewer Mode</h2>
        <div id="login-form">
            <input type="number" id="room-input" placeholder="Enter Room Code">
            <button onclick="joinRoom()">Enter Room</button>
        </div>

        <div id="live-feed" style="display:none; width:100%; display:flex; flex-direction:column; align-items:center;">
            <p>Connected to: <span id="user-room-disp" style="color:#0f0"></span></p>
            <div id="scan-history" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        </div>
        <button onclick="location.reload()" style="background: #333; margin-top:20px;">Exit</button>
    </div>

</div>

<script>
    const socket = io();
    let currentRoom = null;
    let html5QrCode;
    let isScanning = true; // Debounce flag

    // --- SETUP ADMIN ---
    function setupAdmin() {
        socket.emit('create_room');
    }

    socket.on('room_created', (roomCode) => {
        currentRoom = roomCode;
        switchView('admin-view');
        document.getElementById('admin-room-code').innerText = roomCode;
        startFastScanner();
    });

    // --- SETUP USER ---
    function setupUser() {
        switchView('user-view');
    }

    function joinRoom() {
        const code = document.getElementById('room-input').value;
        if (!code) return alert("Enter code");
        socket.emit('join_room', code);
    }

    socket.on('joined_success', (roomCode) => {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('live-feed').style.display = 'flex';
        document.getElementById('user-room-disp').innerText = roomCode;
    });

    // --- THE FAST SCANNER LOGIC ---
    function startFastScanner() {
        html5QrCode = new Html5Qrcode("reader");

        const config = { 
            fps: 30,             // Scan 30 times per second (Very Fast)
            qrbox: { width: 250, height: 250 }, // Focus area
            aspectRatio: 1.0
        };

        // Prefer back camera specifically
        html5QrCode.start(
            { facingMode: "environment" }, 
            config,
            (decodedText, decodedResult) => {
                // SUCCESS
                handleScan(decodedText);
            },
            (errorMessage) => {
                // scanning... (ignore errors to keep console clean)
            }
        ).catch(err => {
            console.error("Camera start failed", err);
            document.getElementById('scan-feedback').innerText = "Camera Error: " + err;
        });
    }

    // Debounce to prevent sending the same code 50 times in 1 second
    let lastScannedCode = "";
    let lastScannedTime = 0;

    function handleScan(text) {
        const now = Date.now();
        // Only send if it's a new code OR if 2 seconds have passed since last scan
        if (text !== lastScannedCode || (now - lastScannedTime) > 2000) {
            
            lastScannedCode = text;
            lastScannedTime = now;

            // Visual Feedback for Admin
            const feedback = document.getElementById('scan-feedback');
            feedback.innerText = "Sent: " + text;
            feedback.style.color = "#0f0";
            setTimeout(() => { feedback.style.color = "#888"; }, 500);

            // Send to Server
            socket.emit('admin_scan_send', { roomCode: currentRoom, data: text });
            
            // OPTIONAL: Vibrate phone on success
            if (navigator.vibrate) navigator.vibrate(200);
        }
    }

    // --- RECEIVE DATA (USER) ---
    socket.on('receive_scan_data', (data) => {
        const history = document.getElementById('scan-history');
        const div = document.createElement('div');
        div.className = 'scanned-data';
        
        if (data.startsWith('http')) {
            div.innerHTML = `<a href="${data}" target="_blank" style="color:#fff; text-decoration:underline;">${data}</a>`;
        } else {
            div.innerText = data;
        }

        history.prepend(div); // Add to top
    });

    // --- UTILS ---
    function switchView(viewId) {
        document.querySelectorAll('.container > div').forEach(el => el.classList.remove('visible'));
        document.getElementById(viewId).classList.add('visible');
    }

</script>
</body>
</html>
