<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaScan</title>
    <style>
        /* Dark Theme for better contrast */
        body { background-color: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 0; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        /* Buttons */
        button { width: 100%; padding: 15px; font-size: 18px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #2196F3; color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        input { width: 90%; padding: 15px; font-size: 18px; text-align: center; border-radius: 8px; border: none; margin-bottom: 20px; }

        /* Scanner Box */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #222; }
        
        /* Result List */
        .list-container { margin-top: 20px; text-align: left; }
        .scan-item { background: #333; padding: 15px; border-bottom: 1px solid #444; word-break: break-all; animation: popIn 0.3s ease-out; display: flex; align-items: center; }
        .scan-item:first-child { border-left: 5px solid #0f0; background: #2a3b2a; } /* Highlight newest */
        
        .index-num { font-size: 20px; font-weight: bold; color: #888; margin-right: 15px; }
        a { color: #64b5f6; text-decoration: none; font-size: 18px; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Views */
        .view { display: none; }
        .active { display: block; }
    </style>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<div class="container">
    
    <div id="view-menu" class="view active">
        <h1>âš¡ Super Fast Scanner</h1>
        <button class="btn-primary" onclick="createRoom()">Start Scanning (Admin)</button>
        <button class="btn-primary" onclick="showJoin()">View Scans (User)</button>
    </div>

    <div id="view-admin" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:1.2em;">Room: <b id="admin-room-code" style="color:#0f0">...</b></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 15px; margin:0; font-size:14px;">Exit</button>
        </div>
        <div id="reader"></div>
        <p style="color:#888; font-size:0.9em;">Scanning... (Only QR Codes)</p>
    </div>

    <div id="view-user" class="view">
        <div id="join-section">
            <input type="number" id="room-input" placeholder="Enter Room Code">
            <button class="btn-primary" onclick="joinRoom()">Connect</button>
        </div>
        
        <div id="list-section" style="display:none;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span>Room: <b id="user-room-code"></b></span>
                <button onclick="location.reload()" style="width:auto; padding:5px 15px; margin:0; font-size:14px; background:#444;">Exit</button>
            </div>
            <div id="scan-list" class="list-container"></div>
        </div>
    </div>

</div>

<script>
    const socket = io();
    let html5QrCode;
    let currentRoom = "";
    
    // --- ADMIN ACTIONS ---
    function createRoom() {
        socket.emit('create_room');
    }

    socket.on('room_created', (code) => {
        currentRoom = code;
        document.getElementById('admin-room-code').innerText = code;
        switchView('view-admin');
        startScanner();
    });

    // --- USER ACTIONS ---
    function showJoin() { switchView('view-user'); }

    function joinRoom() {
        const code = document.getElementById('room-input').value;
        if(!code) return alert("Enter code!");
        socket.emit('join_room', code);
    }

    socket.on('joined_success', (code) => {
        document.getElementById('join-section').style.display = 'none';
        document.getElementById('list-section').style.display = 'block';
        document.getElementById('user-room-code').innerText = code;
    });

    // --- UPDATE LIST (Real-time) ---
    socket.on('update_list', (historyArray) => {
        const listEl = document.getElementById('scan-list');
        listEl.innerHTML = ""; // Clear current list

        historyArray.forEach((text, index) => {
            const item = document.createElement('div');
            item.className = 'scan-item';
            
            // Check if URL
            let content = text;
            if(text.startsWith('http')) {
                content = `<a href="${text}" target="_blank">${text}</a>`;
            }

            item.innerHTML = `<span class="index-num">${index + 1}.</span> ${content}`;
            listEl.appendChild(item);
        });
    });

    // --- FAST SCANNER CONFIG ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");

        const config = { 
            fps: 30, // High FPS
            qrbox: { width: 300, height: 300 }, // Larger box = easier aiming
            aspectRatio: 1.0,
            // IMPORTANT: Only scan QR codes, ignore barcodes (Saves CPU)
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
        };

        html5QrCode.start(
            { facingMode: "environment" }, // Force Back Camera
            config,
            (decodedText) => {
                // SUCCESS
                handleScan(decodedText);
            },
            (errorMessage) => {
                // Ignore parse errors for speed
            }
        ).catch(err => alert("Camera Error: " + err));
    }

    // Smart Debounce: Only block if it's the EXACT SAME code instantly.
    // If you scan Code A then Code B, it happens instantly.
    let lastCode = "";
    let lastTime = 0;

    function handleScan(text) {
        const now = Date.now();
        
        // Block only if same code scanned within 2.5 seconds
        if (text === lastCode && (now - lastTime) < 2500) {
            return; 
        }

        lastCode = text;
        lastTime = now;

        // Vibrate for feedback
        if(navigator.vibrate) navigator.vibrate(100);

        // Send to server
        socket.emit('admin_scan_send', { roomCode: currentRoom, data: text });
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
